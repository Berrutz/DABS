version: "3.9"
name: sdai
services:
  tailscale:
    image: tailscale/tailscale:stable
    container_name: jade-main-tailscale
    hostname: ${TAILSCALE_HOSTNAME:-jade-main}
    profiles: ["main"]
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun
    volumes:
      - tailscale-state:/var/lib/tailscale
    environment:
      TS_STATE_DIR: /var/lib/tailscale
      TS_AUTHKEY: ${TS_AUTHKEY:-}
      TS_EXTRA_ARGS: ${TS_EXTRA_ARGS:-}
    command: tailscaled
    restart: unless-stopped

  # ===== MAIN (DF/AMS) =====
  jade-main:
    build:
      context: ..   # build from the "jade/" root
      dockerfile: docker/Dockerfile
    image: sdai:main
    container_name: jade-main
    profiles: ["main"]
    depends_on:
      - tailscale
    network_mode: "service:tailscale"
    environment:
      ROLE: "main"
      # For local usage expose the Main as "jade-main" (Docker network DNS)
      PUBLIC_HOST: ${PUBLIC_HOST:-}
      PORT: "1099"
      HTTP_PORT: "7778"
      SRC_DIR: "/app/"  
      OUT_DIR: "/app/out"
      LIB_DIR: "/app/web-ui/lib"
    # Network namespace is shared with the Tailscale sidecar

  # ===== ROLE SHORTCUT =====

  jade-agent:
    # If the image is not present locally, build it using the same Dockerfile as the main
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: sdai:main
    container_name: jade-agent
    profiles: ["agent"]
    environment:
      ROLE: "agent"
      # Connect to the local Main by service name
      MAIN_HOST: ${MAIN_HOST:-jade-main}
      # Default advertised host is the compose service name; override for remote hosts
      PUBLIC_HOST: ${PUBLIC_HOST:-$${COMPOSE_SERVICE}}
      PORT: "1099"
      SRC_DIR: "/app/"
      OUT_DIR: "/app/out"
      LIB_DIR: "/app/web-ui/lib"
      MAIN_MONITOR_AUTOSTART : "1"   # auto-start monitor in the background
    ports:
      - "1099:1099"
      - "7778:7778"
    networks: 
      - sdai-net
    volumes:
      - kb-data:/app/web-ui/kb  # persistent KB data

 # ===== PRESET: UserAgent + GUI (server.js) =====
  user-ui:
    extends:
      service: jade-agent         # reuse base image/entrypoint/env
    container_name: user-ui
    environment:
      AGENTS: "user:agents.UserAgent"
      UI_AUTOSTART: "1"          # auto-start npm in the background
      QUERY_HOST: ${QUERY_HOST:-query}
      QUERY_PORT: ${QUERY_PORT:-5001}

  # ===== PRESET: ParserAgent =====
  parser:
    extends:
      service: jade-agent
    container_name: parser
    profiles: ["agent"]
    environment:
      AGENTS: "parser:agents.ParserAgent"
      FRONT_HOST: ${FRONT_HOST:-user-ui}
      FRONT_PORT: ${FRONT_PORT:-5002}

  # ===== PRESET: LogicAgent =====
  logic:
    extends:
      service: jade-agent
    container_name: logic
    profiles: ["agent"]
    environment:
      AGENTS: "logic:agents.LogicAgent"
      FRONT_HOST: ${FRONT_HOST:-user-ui}
      FRONT_PORT: ${FRONT_PORT:-5002}

  # ===== PRESET: QueryAgent =====
  query:
    extends:
      service: jade-agent
    container_name: query
    profiles: ["agent"]
    environment:
      AGENTS: "query:agents.QueryAgent"
      FRONT_HOST: ${FRONT_HOST:-user-ui}
      FRONT_PORT: ${FRONT_PORT:-5002}

    
# ==== NETWORKS & VOLUMES ====
#networks:
#  sdai-net:
#    driver: bridge

volumes:
  kb-data:
  tailscale-state:
