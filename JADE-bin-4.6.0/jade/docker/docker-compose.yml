name: sdai

# Base compose â€” pure JADE containers, standard Docker networking.
# Works as-is for local single-machine use (together with docker-compose.local.yml).
# For distributed Tailscale deployment, layer docker-compose.tailscale.yml on top.

services:

  # ===== MAIN (DF/AMS + MonitorAgent) =====
  jade-main:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: sdai:main
    container_name: jade-main
    profiles: ["main"]
    environment:
      ROLE: "main"
      PUBLIC_HOST: ${PUBLIC_HOST:-jade-main}
      PORT: "1099"
      HTTP_PORT: "7778"
      OUT_DIR: "/app/out"
      LIB_DIR: "/app/web-ui/lib"

  # ===== BASE AGENT (extended by all agent presets) =====
  jade-agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: sdai:main
    container_name: jade-agent
    profiles: ["agent"]
    environment:
      ROLE: "agent"
      MAIN_HOST: ${MAIN_HOST:-jade-main}
      PORT: ${PORT:-1099}
      PUBLIC_HOST: ${PUBLIC_HOST:-jade-agent}
      LOCAL_PORT: "2000"
      OUT_DIR: "/app/out"
      LIB_DIR: "/app/web-ui/lib"
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
    volumes:
      - kb-data:/app/web-ui/kb

  # ===== PRESET: UserAgent + GUI (server.js) =====
  user-ui:
    extends:
      service: jade-agent
    container_name: user-ui
    environment:
      AGENTS: "user:agents.UserAgent"
      UI_AUTOSTART: "1"
      QUERY_HOST: ${QUERY_HOST:-query}
      QUERY_PORT: ${QUERY_PORT:-5001}
      PUBLIC_HOST: ${PUBLIC_HOST:-user-ui}
      LOCAL_PORT: "2004"

  # ===== PRESET: ParserAgent =====
  parser:
    extends:
      service: jade-agent
    container_name: parser
    profiles: ["agent"]
    environment:
      AGENTS: "parser:agents.ParserAgent"
      FRONT_HOST: ${FRONT_HOST:-user-ui}
      FRONT_PORT: ${FRONT_PORT:-5002}
      PUBLIC_HOST: ${PUBLIC_HOST:-parser}
      LOCAL_PORT: "2001"

  # ===== PRESET: LogicAgent =====
  logic:
    extends:
      service: jade-agent
    container_name: logic
    profiles: ["agent"]
    environment:
      AGENTS: "logic:agents.LogicAgent"
      FRONT_HOST: ${FRONT_HOST:-user-ui}
      FRONT_PORT: ${FRONT_PORT:-5002}
      PUBLIC_HOST: ${PUBLIC_HOST:-logic}
      LOCAL_PORT: "2002"

  # ===== PRESET: QueryAgent =====
  query:
    extends:
      service: jade-agent
    container_name: query
    profiles: ["agent"]
    environment:
      AGENTS: "query:agents.QueryAgent"
      FRONT_HOST: ${FRONT_HOST:-user-ui}
      FRONT_PORT: ${FRONT_PORT:-5002}
      PUBLIC_HOST: ${PUBLIC_HOST:-query}
      LOCAL_PORT: "2003"

volumes:
  kb-data:
